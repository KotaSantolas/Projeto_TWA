extends ../layout

block content
  //- CSS e JS do Flatpickr via CDN
  link(rel='stylesheet', href='https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css')
  link(rel='stylesheet', href='https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css')
  link(rel='stylesheet', href='/css/calendario.css')

  .page-header
    h1= reserva ? 'Editar Reserva' : 'Nova Reserva'
    a.btn.btn-primary(href='/reservas') Voltar
  
  if error
    .alert.alert-danger= error

  .card
    if reserva
      //- MODO EDI√á√ÉO: Formul√°rio tradicional com data pr√©-preenchida
      form(action=`/reservas/${reserva.id}`, method='POST')
        p 
          strong Cliente: 
          | #{reserva.cliente_nome}
        
        .form-group
          label(for='barbeiro_id') Barbeiro *
          select#barbeiro_id(name='barbeiro_id', required)
            option(value='') Selecione um barbeiro
            each barbeiro in barbeiros
              option(value=barbeiro.id, selected=reserva.barbeiro_id == barbeiro.id)= barbeiro.nome
        
        .form-group
          label(for='opcao_id') Servi√ßo *
          select#opcao_id(name='opcao_id', required)
            option(value='') Selecione um servi√ßo
            each servico in servicos
              option(value=servico.id, selected=reserva.opcao_id == servico.id)= `${servico.nome_opcao} - ${servico.duracao_min}min - ‚Ç¨${servico.preco}`
        
        .form-group
          label(for='data_hora') Data e Hora *
          input#data_hora(
            type='datetime-local', 
            name='data_hora', 
            value=reserva.data_hora_formatada, 
            data-original=reserva.data_hora_formatada,
            required
          )
          small Hor√°rios dispon√≠veis de 30 em 30 minutos (09:00, 09:30, 10:00...). Pode manter a data original mesmo sendo passada.
        
        .form-group
          label(for='estado') Estado *
          select#estado(name='estado', required)
            option(value='pendente', selected=reserva.estado === 'pendente') Pendente
            option(value='confirmada', selected=reserva.estado === 'confirmada') Confirmada
            option(value='conclu√≠da', selected=reserva.estado === 'conclu√≠da') Conclu√≠da
            option(value='cancelada', selected=reserva.estado === 'cancelada') Cancelada
            option(value='n√£o_compareceu', selected=reserva.estado === 'n√£o_compareceu') N√£o Compareceu
        
        .form-group
          label(for='observacoes') Observa√ß√µes
          textarea#observacoes(name='observacoes', rows='3')= reserva.observacoes || ''
        
        button.btn.btn-success(type='submit') Atualizar
      
      //- Script de valida√ß√£o INTELIGENTE para hor√°rios no modo edi√ß√£o
      script.
        document.addEventListener('DOMContentLoaded', function() {
          const dataHoraInput = document.getElementById('data_hora');
          
          if (dataHoraInput) {
            // Guardar a data original
            const dataOriginal = dataHoraInput.getAttribute('data-original');
            
            // N√ÉO definir min - permite qualquer data
            // Valida√ß√£o ser√° feita no submit
            
            // Validar ao submeter o formul√°rio
            dataHoraInput.closest('form').addEventListener('submit', function(e) {
              const valor = dataHoraInput.value;
              
              if (valor) {
                const dataSelecionada = new Date(valor);
                const agora = new Date();
                
                // NOVA L√ìGICA: S√≥ bloquear se for data passada E diferente da original
                const dataFoiAlterada = valor !== dataOriginal;
                
                if (dataFoiAlterada && dataSelecionada < agora) {
                  e.preventDefault();
                  alert('‚ùå N√£o √© poss√≠vel alterar para uma data/hora passada.\\n\\nüí° Sugest√£o: Mantenha a data original ou escolha uma data futura.');
                  dataHoraInput.focus();
                  return false;
                }
                
                const minutos = dataSelecionada.getMinutes();
                
                // Permitir apenas minutos 00 ou 30
                if (minutos !== 0 && minutos !== 30) {
                  e.preventDefault();
                  alert('Por favor, escolha um hor√°rio com minutos :00 ou :30 (ex: 09:00, 09:30, 10:00...)');
                  dataHoraInput.focus();
                  return false;
                }
                
                // Validar hor√°rio de funcionamento (09:00 - 19:00)
                const hora = dataSelecionada.getHours();
                if (hora < 9 || hora >= 19) {
                  e.preventDefault();
                  alert('Por favor, escolha um hor√°rio entre 09:00 e 19:00');
                  dataHoraInput.focus();
                  return false;
                }
                
                // Validar pausa de almo√ßo (12:00 - 13:00)
                if (hora === 12) {
                  e.preventDefault();
                  alert('N√£o √© poss√≠vel agendar durante a pausa de almo√ßo (12:00 - 13:00)');
                  dataHoraInput.focus();
                  return false;
                }
                
                // Validar domingo (0 = domingo)
                const diaSemana = dataSelecionada.getDay();
                if (diaSemana === 0) {
                  e.preventDefault();
                  alert('A barbearia est√° fechada aos domingos.');
                  dataHoraInput.focus();
                  return false;
                }
              }
            });
            
            // Corrigir automaticamente ao sair do campo
            dataHoraInput.addEventListener('blur', function() {
              const valor = this.value;
              
              if (valor) {
                const data = new Date(valor);
                const minutos = data.getMinutes();
                
                // Se n√£o for :00 ou :30, arredondar para o mais pr√≥ximo
                if (minutos !== 0 && minutos !== 30) {
                  const minutosCorrigidos = minutos < 30 ? 0 : 30;
                  data.setMinutes(minutosCorrigidos);
                  data.setSeconds(0);
                  data.setMilliseconds(0);
                  
                  // Formatar de volta para datetime-local
                  const ano = data.getFullYear();
                  const mes = String(data.getMonth() + 1).padStart(2, '0');
                  const dia = String(data.getDate()).padStart(2, '0');
                  const hora = String(data.getHours()).padStart(2, '0');
                  const min = String(data.getMinutes()).padStart(2, '0');
                  
                  this.value = `${ano}-${mes}-${dia}T${hora}:${min}`;
                }
              }
            });
          }
        });


    else
      //- MODO CRIA√á√ÉO: Sistema de calend√°rio em 3 passos
      form(action='/reservas', method='POST')
        
        //- Hidden inputs para armazenar dados
        input#data_selecionada(type='hidden', name='data_selecionada')
        input#horario_selecionado(type='hidden', name='horario_selecionado')
        input#data_hora(type='hidden', name='data_hora', required)

        //- PASSO 1: Selecionar Cliente, Barbeiro e Servi√ßo
        #passo1.passo.ativo
          .passo-header
            .passo-numero 1
            .passo-titulo Escolha o Cliente, Barbeiro e Servi√ßo
          
          .form-group
            label(for='cliente_id') Cliente *
            select#cliente_id(name='cliente_id', required)
              option(value='') Selecione um cliente
              each cliente in clientes
                option(value=cliente.id)= cliente.nome
          
          .form-group
            label(for='barbeiro_id') Barbeiro *
            select#barbeiro_id(name='barbeiro_id', required)
              option(value='') Selecione um barbeiro
              each barbeiro in barbeiros
                option(value=barbeiro.id)= barbeiro.nome
          
          .form-group
            label(for='opcao_id') Servi√ßo *
            select#opcao_id(name='opcao_id', required)
              option(value='') Selecione um servi√ßo
              each servico in servicos
                option(value=servico.id)= `${servico.nome_opcao} - ${servico.duracao_min}min - ‚Ç¨${servico.preco}`
          
          .mensagem-info
            | ‚ÑπÔ∏è Ap√≥s selecionar o barbeiro e o servi√ßo, poder√° escolher a data e o hor√°rio.

        //- PASSO 2: Selecionar Data no Calend√°rio
        #passo2.passo
          .passo-header
            .passo-numero 2
            .passo-titulo Escolha a Data
          
          .calendario-container
            #calendario
          
          .passo-botoes
            button#btn-voltar-2.btn-voltar(type='button') ‚Üê Voltar

        //- PASSO 3: Selecionar Hor√°rio
        #passo3.passo
          .passo-header
            .passo-numero 3
            .passo-titulo Escolha o Hor√°rio
          
          .mensagem-info
            | üìÖ Hor√°rios dispon√≠veis para a data selecionada:
          
          #horarios-lista.horarios-lista
            .loading A carregar...

          .passo-botoes
            button#btn-voltar-3.btn-voltar(type='button') ‚Üê Voltar ao Calend√°rio

        //- RESUMO E CONFIRMA√á√ÉO
        #resumo-final
          .resumo-reserva
            h3 üìã Resumo da Reserva
            #resumo-info
              p.mensagem-info Selecione todos os passos acima para ver o resumo.
          
          .form-group
            label(for='observacoes') Observa√ß√µes (opcional)
            textarea#observacoes(name='observacoes', rows='3', placeholder='Alguma observa√ß√£o especial?')
          
          button.btn.btn-success(type='submit') ‚úì Confirmar Reserva

  //- Scripts do Flatpickr no final
  script(src='https://cdn.jsdelivr.net/npm/flatpickr')
  script(src='https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js')
  script(src='/js/reservas.js')
